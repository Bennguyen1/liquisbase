<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet id="2" author="dlienko">
                <sql>
                    UPDATE location
                    SET company_contacts = jsonb_set(
                            company_contacts,
                            '{phoneNumbers}',
                            (
                                SELECT jsonb_agg(
                                               jsonb_build_object(
                                                       'name', p ->> 'name',
                                                       'phoneNumber', CONCAT('+84', SUBSTRING(p ->> 'phoneNumber', 1))
                                                   )
                                           )
                                FROM jsonb_array_elements(company_contacts -> 'phoneNumbers') AS p
                                WHERE p ->> 'phoneNumber' LIKE '7%'
                        )
    );
                </sql>
    </changeSet>

</databaseChangeLog>
